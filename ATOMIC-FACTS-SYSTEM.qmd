# ğŸ”¬ ATOMIC-FACTS-SYSTEM.qmd

ğŸ”§ QMD TAGS: SKILL, MEMORY, ENRICHMENT, FACTS, QWENNY, COBRACLAW

---

## ğŸ¦€ Overview

**Atomic Facts System** - Extracts structured facts from files and builds an entity knowledge graph. Single-source-of-truth for people, projects, preferences, and context.

**Key Features:**
- ğŸ” Crawl QMD/MD files for facts
- ğŸ·ï¸ Categorize facts (milestone, status, relationship, preference, context)
- ğŸ‘¤ Build entity profiles (Dan, Owen, Lily, partners, projects)
- ğŸ”„ Update facts over time (Hotâ†’Warmâ†’Cold tiers)
- ğŸ§  Persist for future sessions

---

## ğŸ’¥ How It Works

### Atomic Fact Structure

```markdown
## Entity: [NAME]

### Facts
- [TIMESTAMP] [TYPE] [FACT_TEXT]
- [TIMESTAMP] [TYPE] [FACT_TEXT]

### Meta
- First seen: [DATE]
- Last updated: [DATE]
- Fact count: [N]
```

### Fact Categories

| Type | Emoji | Purpose |
|------|-------|---------|
| **milestone** | ğŸ† | Achievements, completions |
| **status** | ğŸ“Š | Current state, progress |
| **relationship** | ğŸ”— | Connections between entities |
| **preference** | ğŸ’œ | Likes, dislikes, choices |
| **context** | ğŸ“ | Background, notes |
| **learning** | ğŸ’¡ | Lessons, insights |

### Crawl â†’ Extract â†’ Enrich Flow

```
1. CRAWL   â†’ Find QMD/MD files needing enrichment
2. SCAN    â†’ Extract sentences with entity keywords
3. CLASSIFY â†’ Categorize as fact type
4. VALIDATE â†’ Check length (15-200 chars), deduplicate
5. ENRICH  â†’ Add to entity or create new
6. REPORT  â†’ Summary of changes
```

---

## ğŸ¥‹ Implementation Notes

### Files Touched
- `ATOMIC-FACTS-SYSTEM.qmd` (this file - contains all scripts!)
- `teddy-brain/memory/entities.qmd` (entity storage)

### Main Script (embedded in this QMD)

```bash
#!/bin/bash
# ğŸ”¬ ATOMIC FACTS ENRICHMENT - EMBEDDED IN ATOMIC-FACTS-SYSTEM.qmd
# Extract facts from files, build entity knowledge graph

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKSPACE="$HOME/.openclaw/workspace"
ENTITIES_FILE="$WORKSPACE/teddy-brain/memory/entities.qmd"

log() {
  echo "[$(date '+%Y-%m-%d %H:%M')] $1"
}

dry_run=false
if [ "$1" = "--dry-run" ] || [ "$1" = "dry-run" ]; then
  dry_run=true
fi

echo "ğŸ”¬ ATOMIC FACTS ENRICHMENT"
echo "=========================="

if $dry_run; then
  echo "DRY RUN MODE - No changes will be made"
fi

# Phase 1: Find files to scan
log "Phase 1: Finding files to scan..."
FILES=($(find "$WORKSPACE" -name "*.md" -o -name "*.qmd" 2>/dev/null | grep -v archive | grep -v ".git" | grep -v checkpoints))

if [ ${#FILES[@]} -eq 0 ]; then
  echo "No files found to scan."
  exit 0
fi

echo "Found ${#FILES[@]} files to scan."

# Phase 2: Scan for entity keywords
log "Phase 2: Scanning for entity keywords..."
KEYWORDS=("Dan" "Owen" "Lily" "Axon" "Teddy" "Partner" "Project")

new_facts=0

for file in "${FILES[@]}"; do
  filename=$(basename "$file")
  
  # Skip the entities file itself
  if [[ "$filename" == "entities.qmd" ]]; then
    continue
  fi
  
  log "  Scanning: $filename"
  
  # Extract sentences with keywords (FIXED: null-terminated for xargs safety)
  for keyword in "${KEYWORDS[@]}"; do
    grep -Zi "$keyword" "$file" 2>/dev/null | while IFS= read -r -d '' line; do
      # Clean and validate line - avoid xargs for special chars
      clean=$(echo "$line" | sed 's/[[:space:]]\+/ /g' | xargs -0 printf '%s' 2>/dev/null || echo "$line")
      clean=$(echo "$clean" | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')
      len=${#clean}
      
      if [ $len -gt 15 ] && [ $len -lt 200 ]; then
        # Determine fact type
        case "$(echo "$clean" | tr '[:upper:]' '[:lower:]')" in
          *love*|*hate*|*prefer*|*likes*|*dislikes*) TYPE="preference" ;;
          *born*|*age*|*date*) TYPE="context" ;;
          *complete*|*done*|*finished*|*achieved*) TYPE="milestone" ;;
          *working*|*status*|*progress*) TYPE="status" ;;
          *friend*|*partner*|*team*|*relationship*) TYPE="relationship" ;;
          *built*|*created*|*made*) TYPE="milestone" ;;
          *runs*|*uses*|*operates*) TYPE="context" ;;
          *) TYPE="learning" ;;
        esac
        
        fact_line="[$(date '+%Y-%m-%d')] [$TYPE] $clean"
        
        # Check if fact already exists
        if ! grep -qF "$clean" "$ENTITIES_FILE" 2>/dev/null; then
          if ! $dry_run; then
            echo "$fact_line" >> "$ENTITIES_FILE.tmp"
            ((new_facts++))
          else
            echo "    NEW: $fact_line"
          fi
        fi
      fi
    done
  done
done

# Phase 3: Deduplicate and update
if ! $dry_run; then
  log "Phase 3: Deduplicating..."
  if [ -f "$ENTITIES_FILE.tmp" ]; then
    sort -u "$ENTITIES_FILE.tmp" >> "$ENTITIES_FILE"
    rm "$ENTITIES_FILE.tmp"
  fi
fi

# Phase 4: Report
log "Phase 4: Reporting..."
echo ""
echo "ğŸ“Š ENTITY SUMMARY:"
echo "================="
echo ""
echo "Entities with facts:"
grep "^## Entity:" "$ENTITIES_FILE" 2>/dev/null | while read entity; do
  entity_name=$(echo "$entity" | sed 's/## Entity: //')
  count=$(grep -A 20 "^## Entity: $entity_name" "$ENTITIES_FILE" 2>/dev/null | grep -c "^\-" || echo "0")
  echo "  - $entity_name: $count facts"
done

echo ""
if $dry_run; then
  echo "ğŸ”¬ DRY RUN COMPLETE - No changes made"
else
  echo "ğŸ”¬ Enrichment complete. $new_facts new facts added."
fi

# Show recent facts
echo ""
echo "ğŸ“ RECENT FACTS:"
echo "================"
tail -10 "$ENTITIES_FILE" 2>/dev/null | grep -E "^\[" || echo "No facts yet."
```

### Test Script (embedded in this QMD)

```bash
#!/bin/bash
# TEST: Atomic Facts Enrichment - xargs Quote Bug
# Bug: Script produces "xargs: unterminated quote" errors
# Fix: Use null-terminated output (grep -Z, while read -d '')

SCRIPT="$HOME/.openclaw/workspace/scripts/enrich-atomic-facts.sh"

echo "=== ATOMIC FACTS XARGS BUG TEST ==="
echo ""

# Run the script and capture output
OUTPUT=$($SCRIPT 2>&1)
ERROR_COUNT=$(echo "$OUTPUT" | grep -c "xargs: unterminated quote" 2>/dev/null | head -1 || echo "0")

# Ensure ERROR_COUNT is a number
if ! [[ "$ERROR_COUNT" =~ ^[0-9]+$ ]]; then
    ERROR_COUNT=0
fi

echo "xargs errors found: $ERROR_COUNT"

if [ "$ERROR_COUNT" -gt 0 ]; then
    echo "âŒ TEST FAILED: xargs quote bug exists"
    echo "Sample errors:"
    echo "$OUTPUT" | grep "xargs: unterminated quote" | head -3
    exit 1
else
    echo "âœ… TEST PASSED: No xargs errors"
    exit 0
fi
```

---

## ğŸ¯ Usage Examples

### Run Enrichment
```bash
# Copy the main script from this QMD and run:
./enrich-atomic-facts.sh

# Or dry run
./enrich-atomic-facts.sh dry-run
```

### Run Tests
```bash
# Copy the test script from this QMD and run:
./test-atomic-facts-xargs.sh
```

### Query Entity
```bash
grep -A 20 "## Entity: OWEN" teddy-brain/memory/entities.qmd
```

---

## ğŸ“– Cobra Kai Vibes

> "Knowledge is power. Every fact, a weapon."
> â€” The Creed

**Atomic Facts Philosophy:**
```
ğŸ”¬ Precision over volume
ğŸ·ï¸ Categories give structure
ğŸ”„ Facts evolve over time
ğŸ§  Memory compounds
ğŸ’ª Single source of truth
```

---

## ğŸ”„ Test Strikes

```bash
# 1. Test file discovery (dry run)
./enrich-atomic-facts.sh dry-run

# 2. Run full enrichment
./enrich-atomic-facts.sh

# 3. Test for xargs bugs
./test-atomic-facts-xargs.sh

# 4. Check entity output
cat teddy-brain/memory/entities.qmd

# 5. Query specific entity
grep -A 50 "## Entity: DAN" teddy-brain/memory/entities.qmd
```

---

## ğŸ”¬ Complete

**QMD: ATOMIC-FACTS-SYSTEM - CONSOLIDATED**
- âœ… Main script embedded (with xargs fix)
- âœ… Test script embedded
- âœ… No standalone .sh files needed
- âœ… All in one QMD

**Commit:** `QMD: ATOMIC-FACTS-SYSTEM - Consolidated! No more standalone .sh files! All embedded! ğŸ”¬âœ…`

---

**ğŸ”¬ "One QMD. All scripts. No shell sprawl." ğŸ”¬**

# @qmd:tags=atomic,facts,entities,memory,knowledge-graph,consolidated,cobraclaw
# @qmd:version=2.0
